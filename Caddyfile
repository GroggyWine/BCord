# =============================================================================
# BeKord - Caddy Web Server Configuration
# =============================================================================
# UPDATED: 2025-12-19
# 
# CHANGE LOG:
# -----------
# 2025-12-19: Added bekord.com as primary domain (was only b-cord.run.place)
#             - bekord.com/www.bekord.com: Primary site with full config
#             - b-cord.run.place now redirects to bekord.com
#             - Updated CSP headers for bekord.com WebSocket connections
#             - Added grafana.bekord.com and prometheus.bekord.com subdomains
#
# 2025-12-19: Added rate limiting for security
#             - auth_zone: 10 req/min for /api/auth/* endpoints
#             - api_zone: 100 req/min for general API
#
# 2025-12-19: Added Rumble API proxy route
#             - /api/rumble/* now routes to bcord-rumble-api:3099
#
# 2025-12-19: Fixed CAPTCHA routing (handle instead of handle_path)
#             Fixed CSP to allow Google Fonts
# =============================================================================

{
    email admin@bekord.com
    acme_ca https://acme.zerossl.com/v2/DV90
    
    # Rate limit module ordering
    order rate_limit before basicauth
}

# -----------------------------------------------------------------------------
# HTTP listener for ACME challenges + HTTPâ†’HTTPS redirects (ALL DOMAINS)
# -----------------------------------------------------------------------------
http://bekord.com, http://www.bekord.com, http://b-cord.run.place, http://www.b-cord.run.place {
    handle_path /.well-known/acme-challenge/* {
        root * /var/lib/caddy/.local/share/caddy/acme
        file_server
    }

    redir https://{host}{uri} permanent
}

# -----------------------------------------------------------------------------
# MAIN SITE: bekord.com (PRIMARY DOMAIN)
# -----------------------------------------------------------------------------
https://bekord.com, https://www.bekord.com {
    encode zstd gzip

    # Security + CORS headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Resource-Policy "same-site"
        Cross-Origin-Embedder-Policy "credentialless"
        Content-Security-Policy "default-src 'self'; img-src 'self' data: https://1a-1791.com blob:; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' wss://bekord.com wss://www.bekord.com https://bekord.com https://www.bekord.com"
        Access-Control-Allow-Origin https://{host}
        Access-Control-Allow-Credentials true
        Access-Control-Allow-Headers "Authorization, Content-Type"
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        Vary "Origin"
    }

    # CORS preflight handler
    @cors_preflight {
        method OPTIONS
    }
    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin https://{host}
            Access-Control-Allow-Credentials true
            Access-Control-Allow-Headers "Authorization, Content-Type"
            Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
            Vary "Origin"
        }
        respond "" 204
    }

    # Rate limiting: Authentication endpoints (10 req/min - brute force protection)
    @auth_endpoints {
        path /api/auth/login /api/auth/register /api/auth/forgot-password /api/auth/reset-password
    }
    handle @auth_endpoints {
        rate_limit {
            zone auth_zone {
                key {remote_host}
                events 10
                window 1m
            }
        }
        reverse_proxy bcord-backend:9000
    }

    # CAPTCHA proxy - use 'handle' NOT 'handle_path' to preserve the path
    @captcha path /captcha
    handle @captcha {
        reverse_proxy bcord-backend:9000
    }

    # Rumble API - routes to main backend (integrated)
    @rumble_api path /api/rumble/*
    handle @rumble_api {
        reverse_proxy bcord-backend:9000
    }

    # Rate limiting: General API (100 req/min)
    @api path /api/*
    handle @api {
        rate_limit {
            zone api_zone {
                key {remote_host}
                events 200
                window 1m
            }
        }
        reverse_proxy bcord-backend:9000
    }

    # Prometheus metrics endpoint
    handle /metrics {
        header {
            Content-Type "text/plain; version=0.0.4"
            Cache-Control "no-store"
        }
        reverse_proxy bcord-backend:9000
    }

    # WebSocket upgrades - MUST use handle to take priority over static files
    @websocket {
        path /ws
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websocket {
        reverse_proxy bcord-backend:9000
    }

    # Static frontend (React SPA) - serves index.html for all routes
    handle {
        root * /srv/bcord/site
        try_files {path} /index.html
        
        # Prevent caching of index.html so users always get latest JS/CSS references
        @html {
            path /index.html /
        }
        header @html Cache-Control "no-cache, no-store, must-revalidate"
        
        # Allow caching of hashed assets (they have unique names per build)
        @assets {
            path /assets/*
        }
        header @assets Cache-Control "public, max-age=31536000, immutable"
        
        file_server
    }

    # Access logging
    log {
        output file /data/access.log {
            roll_size 10MiB
            roll_keep 5
        }
    }
}

# -----------------------------------------------------------------------------
# LEGACY DOMAIN: b-cord.run.place (redirects to bekord.com)
# -----------------------------------------------------------------------------
https://b-cord.run.place, https://www.b-cord.run.place {
    redir https://bekord.com{uri} permanent
}

# -----------------------------------------------------------------------------
# Monitoring: Grafana Dashboard
# -----------------------------------------------------------------------------
grafana.bekord.com, grafana.b-cord.run.place {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
    }
    reverse_proxy bcord-grafana:3000
}

# -----------------------------------------------------------------------------
# Monitoring: Prometheus
# -----------------------------------------------------------------------------
prometheus.bekord.com, prometheus.b-cord.run.place {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
    }
    reverse_proxy bcord-prometheus:9090
}
